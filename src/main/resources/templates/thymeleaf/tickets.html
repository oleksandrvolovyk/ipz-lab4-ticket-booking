<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/static/tickets_style.css" type="text/css">
    <title>Lab4. Buy Tickets</title>
</head>
<body>

<h1 id="greeting">Вітаю, username !</h1>

<h2>Ваші замовлення</h2>

<table id="ordersTable">
    <thead>
    <tr>
        <th>Номер замовлення</th>
        <th>Назва фільму</th>
        <th>Час</th>
        <th>Номер місця</th>
    </tr>
    </thead>
    <tbody id="ordersBody">
    </tbody>
</table>

<h2>Купити квитки</h2>

<form id="buyForm" method="post" action="/orders">
    <table>
        <thead>
        <tr>
            <th>Купити</th>
            <th>Назва фільму</th>
            <th>Час</th>
            <th>Номер місця</th>
        </tr>
        </thead>
        <tbody>
        <!-- Loop through the list of tickets -->
        <tr th:each="ticket : ${tickets}">
            <td>
                <!-- Add a checkbox for each ticket -->
                <input type="checkbox" name="ticketIds" th:value="${ticket.ticketId}">
            </td>
            <td th:text="${ticket.movieTitle}"></td>
            <!-- Format timestamp to display as a readable date -->
            <td th:text="${#dates.format(new java.util.Date(ticket.time), 'dd-MM-yyyy HH:mm')}"></td>
            <td th:text="${ticket.placeNumber}"></td>
        </tr>
        </tbody>
    </table>

    <!-- Add a Buy button to submit the form -->
    <button type="button" onclick="buyTickets()">Buy</button>
</form>

<!-- JavaScript to handle orders display -->
<script>
    window.onload = function () {
        const viewerId = localStorage.getItem("viewerId")
        if (viewerId) {
            // Make a fetch POST request with the JSON payload
            fetch(`/api/viewers/${viewerId}`, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const greeting = document.getElementById("greeting")
                    greeting.innerText = `Вітаю, ${data.fullName}!`
                })
                .catch(error => {
                    // Handle errors
                    console.error('There was a problem with the fetch operation:', error);
                });
        } else {
            alert("Спочатку зареєструйтесь!")
        }

        if (viewerId) {
            // Make a fetch GET request to fetch orders
            fetch(`/api/viewers/${viewerId}/orders`, {
                method: 'GET'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Display orders in the table
                    const ordersTableBody = document.getElementById("ordersBody");
                    data.forEach(order => {
                        const row = ordersTableBody.insertRow();
                        const orderIdCell = row.insertCell()
                        orderIdCell.innerText = order.orderId;
                        orderIdCell.rowSpan = order.tickets.length + 1

                        // Loop through the list of tickets in each order
                        order.tickets.forEach(ticket => {
                            const ticketRow = ordersTableBody.insertRow()
                            ticketRow.insertCell().innerText = ticket.movieTitle;
                            ticketRow.insertCell().innerText = new Date(ticket.time).toLocaleString();
                            ticketRow.insertCell().innerText = ticket.placeNumber;
                        });
                    });
                })
                .catch(error => {
                    // Handle errors
                    console.error('There was a problem with the fetch operation:', error);
                });
        } else {
            alert("Спочатку зареєструйтесь!")
        }
    };
</script>

<!-- JavaScript to handle the form submission -->
<script>
    function buyTickets() {
        // Get the form element
        const form = document.getElementById('buyForm');

        // Create an array to store selected ticket ids
        const selectedTickets = [];

        // Get all checkboxes with the name "ticketIds"
        let checkboxes = form.elements['ticketIds'];

        if (checkboxes.length === undefined) {
            checkboxes = [checkboxes]
        }

        // Loop through checkboxes to find selected ones
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                selectedTickets.push(parseInt(checkboxes[i].value)); // Ensure the ticket ids are integers
                checkboxes[i].checked = false
            }
        }

        // Create the JSON object
        const jsonData = {
            "viewerId": localStorage.getItem("viewerId"),
            "ticketIds": selectedTickets
        };

        // Make a fetch POST request with the JSON payload
        fetch('/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jsonData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Handle the response if needed
                console.log(data);
                location.reload();
            })
            .catch(error => {
                // Handle errors
                console.error('There was a problem with the fetch operation:', error);
            });
    }
</script>

</body>
</html>
